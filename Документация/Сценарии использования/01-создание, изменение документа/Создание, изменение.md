# Прецедент 1: Создание и редактирование документа

## Основная информация

**Рамки:** Приложение «Текстовый редактор» с поддержкой композитной структуры документа  
**Уровень:** Задача, определённая пользователем  
**Основной исполнитель:** Пользователь  

## Заинтересованные лица и их требования

| Лицо | Требования |
|------|------------|
| Пользователь | Хочет создавать и редактировать документы с сохранением структуры (абзацы, предложения, слова) |
| Разработчики | Требуют четкой архитектуры с паттерном Composite для управления элементами документа |

## Предусловия

- Приложение запущено
- Система готова к созданию новых документов

## Постусловия (результаты)

- Новый документ создан с иерархической структурой
- Текст разбит на структурные элементы (абзацы, предложения, слова)
- Курсор инициализирован для редактирования

## Основной успешный сценарий

1. Пользователь создает новый документ с именем
2. Система инициализирует документ с композитной структурой
3. Пользователь вводит текст
4. Система автоматически разбивает текст на структурные элементы:
   - Абзацы (Paragraph)
   - Предложения (Sentence) 
   - Слова (Word)
   - Буквы (Letter)
5. Пользователь выполняет операции замены текста
6. Система обходит структуру документа и обновляет соответствующие элементы

## Расширения (альтернативные потоки)

### 4а. Сложная структура текста
- Система автоматически определяет границы предложений и абзацев
- Создает соответствующую иерархию элементов

### 6а. Частичное совпадение при замене
- Система находит и заменяет только полные совпадения
- Сохраняет целостность структурных элементов

## Специальные требования

- Поддержка композитной структуры документа
- Автоматическое разбиение текста на логические элементы
- Рекурсивный обход структуры для операций поиска и замены
- Инициализация курсора для навигации по документу

## Частота использования

**Очень высокая:** базовые операции создания и редактирования документов

## Технические особенности

- **Паттерн Composite:** для управления иерархией элементов документа
- **Рекурсивный обход:** для операций над всей структурой документа
- **Автоматическое парсинг:** разбиение текста на структурные элементы

## Диаграмма последовательности создания и редактирования документа

```mermaid
sequenceDiagram
    autonumber

    participant User
    participant Main
    participant Editor
    participant Document
    participant CompositeManager
    participant Paragraph
    participant Sentence
    participant Word
    participant Letter
    participant Cursor

    %% ==========================================
    %% 1) СОЗДАНИЕ ДОКУМЕНТА
    %% ==========================================

    Note over User,Editor: 1) Создание нового документа

    User->>Main: Создать новый документ("mydoc")
    Main->>Editor: NewDocument("mydoc")
    activate Editor

    Editor->>Document: <<create>> Document("mydoc")
    activate Document

    Document->>Cursor: <<create>> Cursor()
    Cursor-->>Document: cursor initialized

    Document-->>Editor: документ создан
    deactivate Document

    Editor-->>Main: Document создан
    deactivate Editor

    %% ==========================================
    %% 2) ДОБАВЛЕНИЕ ТЕКСТА
    %% ==========================================

    Note over User,Editor: 2) Добавление текста в документ

    User->>Main: Ввод текста: "Hello world!"
    Main->>Editor: InsertText("Hello world!")
    activate Editor

    Editor->>Document: Add("Hello world!")
    activate Document

    %% ---- Document вызывает CompositeManager ----
    Document->>CompositeManager: Add(document, "Hello world!")
    activate CompositeManager

    %% ---- Разбиение текста ----
    Document->>Document: SplitIfNeeded("Hello world!")

    %% ---- Создание структуры Composite ----
    Document->>Paragraph: <<create>> Paragraph()
    activate Paragraph
    CompositeManager->>Document: Add(document, Paragraph)

    Document->>Sentence: <<create>> Sentence()
    activate Sentence
    CompositeManager->>Paragraph: Add(Paragraph, Sentence)

    %% ---- Word 1 ----
    Document->>Word: <<create>> Word("Hello")
    activate Word
    CompositeManager->>Sentence: Add(Sentence, Word)

    Word->>Word: GetText()
    Word->>Letter: <<create>> Letters(H,e,l,l,o)
    deactivate Word

    %% ---- Word 2 ----
    Document->>Word: <<create>> Word("world!")
    activate Word
    CompositeManager->>Sentence: Add(Sentence, Word)

    Word->>Word: GetText()
    Word->>Letter: <<create>> Letters(w,o,r,l,d,!)
    deactivate Word

    deactivate Sentence
    deactivate Paragraph

    CompositeManager-->>Document: добавление завершено
    deactivate CompositeManager

    Document-->>Editor: текст добавлен
    deactivate Document

    Editor-->>Main: Добавление текста выполнено
    deactivate Editor

    %% ==========================================
    %% 3) ЗАМЕНА ТЕКСТА
    %% ==========================================

    Note over User,Editor: 3) Замена текста в документе

    User->>Main: Изменить текст: "Hello", "Hi"
    Main->>Editor: ReplaceAll("Hello", "Hi")
    activate Editor

    Editor->>CompositeManager: ReplaceText(Document, "Hello", "Hi")
    activate CompositeManager

    %% ---- Обход Composite через Traverse() ----
    CompositeManager->>CompositeManager: Traverse(Document, replace)

    CompositeManager->>Document: traverse paragraphs
    CompositeManager->>Paragraph: traverse sentences
    CompositeManager->>Sentence: traverse words

    %% ---- Проверка слова ----
    CompositeManager->>Word: GetText()
    Word-->>CompositeManager: "Hello"

    %% ---- Замена ----
    CompositeManager->>Word: ReplaceText("Hello", "Hi")
    Word->>Word: SetText("Hi")

    CompositeManager-->>Editor: замена завершена
    deactivate CompositeManager

    Editor-->>Main: ReplaceAll выполнен
    deactivate Editor
```

## Структурные элементы документа

| Элемент | Описание | Ответственность |
|---------|----------|-----------------|
| **Document** | Основной контейнер документа | Управление всей структурой |
| **Paragraph** | Абзац текста | Содержит предложения |
| **Sentence** | Предложение | Содержит слова |
| **Word** | Слово | Содержит буквы |
| **Letter** | Буква/символ | Базовый элемент текста |
| **Cursor** | Курсор редактирования | Навигация по документу |

## Операции управления структурой

- **Автоматическое разбиение:** Текст автоматически парсится на структурные элементы
- **Рекурсивный обход:** Операции применяются ко всей иерархии документа
- **Композитное управление:** Единый интерфейс для работы с элементами разного уровня
